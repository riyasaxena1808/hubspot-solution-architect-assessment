<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Breezy Admin – HubSpot Integration POC</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #f4f6f8;
    }
    h1 {
      margin-bottom: 0.5rem;
    }
    h2 {
      margin-top: 2rem;
      margin-bottom: 0.5rem;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }
    section {
      background: #fff;
      border-radius: 8px;
      padding: 1rem 1.2rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.4rem 0.5rem;
      font-size: 0.9rem;
    }
    th {
      background: #f0f3f5;
      text-align: left;
    }
    button {
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #2563eb;
      color: white;
      cursor: pointer;
      font-size: 0.85rem;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
      border-color: #d1d5db;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    input, select {
      padding: 0.35rem 0.5rem;
      font-size: 0.9rem;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .message {
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }
    .message.success {
      color: #065f46;
    }
    .message.error {
      color: #b91c1c;
    }
    .badge {
      display: inline-block;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e5e7eb;
    }
    #contactsLoading, #dealsLoading {
      font-size: 0.85rem;
    }
    .small {
      font-size: 0.8rem;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Breezy Admin – HubSpot Integration POC</h1>
    <p class="small">
      This panel simulates Breezy's internal admin tool, syncing customers and subscriptions with HubSpot.
    </p>

    <!-- A. Sync Customer Data to HubSpot -->
    <section id="contacts-section">
      <div style="display:flex; justify-content: space-between; align-items:center;">
        <h2>Contacts in HubSpot</h2>
        <button id="refreshContactsBtn" class="secondary">Refresh contacts</button>
      </div>
      <div id="contactsLoading" hidden>Loading contacts...</div>
      <div id="contactsError" class="message error"></div>

      <table id="contactsTable">
        <thead>
          <tr>
            <th>Contact ID</th>
            <th>First name</th>
            <th>Last name</th>
            <th>Email</th>
            <th>Job Title</th>
            <th>Company</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filled by JS -->
        </tbody>
      </table>
      <p class="small">
        This shows contacts currently stored in HubSpot (via <code>GET /api/contacts</code>).
      </p>
    </section>

    <section id="create-contact-section">
      <h2>Create / Sync Contact</h2>
      <p class="small">
        When a customer creates an account or purchases a thermostat, we sync them to HubSpot as a contact.
      </p>
      <form id="createContactForm">
        <div class="form-row">
          <div class="form-group">
            <label for="firstname">First name *</label>
            <input id="firstname" name="firstname" required />
          </div>
          <div class="form-group">
            <label for="lastname">Last name *</label>
            <input id="lastname" name="lastname" required />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="email">Email *</label>
            <input id="email" name="email" type="email" required />
          </div>
          <div class="form-group">
            <label for="phone">Phone (optional)</label>
            <input id="phone" name="phone" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="address">Address (optional)</label>
            <input id="address" name="address" />
          </div>
          <div class="form-group">
            <label for="jobtitle">Job title (optional)</label>
            <input id="jobtitle" name="jobtitle" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="company">Company (optional)</label>
            <input id="company" name="company" />
          </div>
        </div>
        <button type="submit">Create & sync contact</button>
        <div id="createContactMessage" class="message"></div>
      </form>
    </section>

    <!-- B. Track Subscription Conversions (Deals) -->
    <section id="create-deal-section">
      <h2>Record Subscription Conversion (Deal)</h2>
      <p class="small">
        When a customer converts to paid Breezy Premium, we create a closed-won deal in HubSpot.
      </p>
      <form id="createDealForm">
        <div class="form-row">
          <div class="form-group">
            <label for="dealContactSelect">Contact *</label>
            <select id="dealContactSelect" required>
              <option value="">-- Select contact --</option>
            </select>
          </div>
          <div class="form-group">
            <label for="dealname">Deal name *</label>
            <input id="dealname" name="dealname" value="Breezy Premium - Annual Subscription" required />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="amount">Amount (USD) *</label>
            <input id="amount" name="amount" type="number" step="0.01" value="99" required />
          </div>
          <div class="form-group">
            <label for="dealstage">Deal stage *</label>
            <select id="dealstage" name="dealstage" required>
              <option value="closedwon" selected>closedwon (Converted)</option>
              <option value="appointmentscheduled">appointmentscheduled (Trial started)</option>
              <option value="qualifiedtobuy">qualifiedtobuy (Active trial)</option>
              <option value="closedlost">closedlost (Did not convert)</option>
            </select>
          </div>
        </div>
        <button type="submit">Create deal</button>
        <div id="createDealMessage" class="message"></div>
      </form>
    </section>

    <section id="deals-section">
      <h2>Deals for Selected Contact</h2>
      <div id="dealsHeader" class="small">
        Click <strong>“View deals”</strong> on a contact above to see their subscription history.
      </div>
      <div id="dealsLoading" hidden>Loading deals...</div>
      <div id="dealsError" class="message error"></div>

      <table id="dealsTable">
        <thead>
          <tr>
            <th>Deal ID</th>
            <th>Deal name</th>
            <th>Amount</th>
            <th>Stage</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filled by JS -->
        </tbody>
      </table>
    </section>
  </div>

  <script>
    // Helper to show messages
    function setMessage(element, text, type) {
      element.textContent = text || "";
      element.classList.remove("success", "error");
      if (!text) return;
      if (type === "success") element.classList.add("success");
      if (type === "error") element.classList.add("error");
    }

    async function loadContacts() {
      const loadingEl = document.getElementById("contactsLoading");
      const errorEl = document.getElementById("contactsError");
      const tableBody = document.querySelector("#contactsTable tbody");
      const contactSelect = document.getElementById("dealContactSelect");

      loadingEl.hidden = false;
      errorEl.textContent = "";
      tableBody.innerHTML = "";
      contactSelect.innerHTML = '<option value="">-- Select contact --</option>';

      try {
        const res = await fetch("/api/contacts");
        if (!res.ok) {
          const errBody = await res.json().catch(() => ({}));
          throw new Error(errBody.error || "Failed to load contacts");
        }
        const data = await res.json();
        const contacts = data.results || [];

        if (!contacts.length) {
          const row = document.createElement("tr");
          row.innerHTML = '<td colspan="7">No contacts found in HubSpot.</td>';
          tableBody.appendChild(row);
          return;
        }

        contacts.forEach(contact => {
          const id = contact.id;
          const props = contact.properties || {};
          const firstname = props.firstname || "";
          const lastname = props.lastname || "";
          const email = props.email || "";
          const jobtitle = props.jobtitle || "";
          const company = props.company || "";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${id}</td>
            <td>${firstname}</td>
            <td>${lastname}</td>
            <td>${email}</td>
            <td>${jobtitle}</td>
            <td>${company}</td>
            <td>
              <button class="secondary view-deals-btn" data-contact-id="${id}" data-contact-name="${firstname} ${lastname || ""}">
                View deals
              </button>
            </td>
          `;
          tableBody.appendChild(tr);

          const option = document.createElement("option");
          option.value = id;
          option.textContent = `${firstname} ${lastname} (${email || id})`;
          contactSelect.appendChild(option);
        });

        document.querySelectorAll(".view-deals-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const contactId = btn.getAttribute("data-contact-id");
            const name = btn.getAttribute("data-contact-name") || contactId;
            loadDealsForContact(contactId, name);
          });
        });
      } catch (err) {
        errorEl.textContent = err.message;
      } finally {
        loadingEl.hidden = true;
      }
    }

    async function loadDealsForContact(contactId, contactName) {
      const headerEl = document.getElementById("dealsHeader");
      const loadingEl = document.getElementById("dealsLoading");
      const errorEl = document.getElementById("dealsError");
      const tableBody = document.querySelector("#dealsTable tbody");

      headerEl.innerHTML = `Deals for <strong>${contactName}</strong> (Contact ID: ${contactId})`;
      loadingEl.hidden = false;
      errorEl.textContent = "";
      tableBody.innerHTML = "";

      try {
        const res = await fetch(`/api/contacts/${contactId}/deals`);
        if (!res.ok) {
          const errBody = await res.json().catch(() => ({}));
          throw new Error(errBody.error || "Failed to load deals for this contact");
        }
        const data = await res.json();
        const deals = data.results || [];

        if (!deals.length) {
          const row = document.createElement("tr");
          row.innerHTML = '<td colspan="4">No deals found for this contact.</td>';
          tableBody.appendChild(row);
          return;
        }

        deals.forEach(deal => {
          const id = deal.id;
          const props = deal.properties || {};
          const dealname = props.dealname || "";
          const amount = props.amount || "";
          const stage = props.dealstage || "";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${id}</td>
            <td>${dealname}</td>
            <td>${amount}</td>
            <td><span class="badge">${stage}</span></td>
          `;
          tableBody.appendChild(tr);
        });
      } catch (err) {
        errorEl.textContent = err.message;
      } finally {
        loadingEl.hidden = true;
      }
    }

    async function handleCreateContact(event) {
      event.preventDefault();
      const messageEl = document.getElementById("createContactMessage");
      setMessage(messageEl, "", "");

      const firstname = document.getElementById("firstname").value.trim();
      const lastname = document.getElementById("lastname").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const address = document.getElementById("address").value.trim();
      const jobtitle = document.getElementById("jobtitle").value.trim();
      const company = document.getElementById("company").value.trim();

      if (!firstname || !lastname || !email) {
        setMessage(messageEl, "First name, last name, and email are required.", "error");
        return;
      }

      const payload = {
        properties: {
          firstname,
          lastname,
          email,
        }
      };
      if (phone) payload.properties.phone = phone;
      if (address) payload.properties.address = address;
      if (jobtitle) payload.properties.jobtitle = jobtitle;
      if (company) payload.properties.company = company;

      const submitBtn = event.target.querySelector("button[type='submit']");
      submitBtn.disabled = true;

      try {
        const res = await fetch("/api/contacts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const errBody = await res.json().catch(() => ({}));
          throw new Error(errBody.error || "Failed to create contact in HubSpot");
        }

        const created = await res.json();
        setMessage(
          messageEl,
          `Contact created in HubSpot (ID: ${created.id}). Refreshing contact list...`,
          "success"
        );

        event.target.reset();
        await loadContacts();
      } catch (err) {
        setMessage(messageEl, err.message, "error");
      } finally {
        submitBtn.disabled = false;
      }
    }

    async function handleCreateDeal(event) {
      event.preventDefault();
      const messageEl = document.getElementById("createDealMessage");
      setMessage(messageEl, "", "");

      const contactId = document.getElementById("dealContactSelect").value;
      const dealname = document.getElementById("dealname").value.trim();
      const amount = document.getElementById("amount").value.trim();
      const dealstage = document.getElementById("dealstage").value;

      if (!contactId) {
        setMessage(messageEl, "Please select a contact for this deal.", "error");
        return;
      }
      if (!dealname || !amount || !dealstage) {
        setMessage(messageEl, "Deal name, amount, and stage are required.", "error");
        return;
      }

      const payload = {
        dealProperties: {
          dealname,
          amount,
          dealstage,
        },
        contactId,
      };

      const submitBtn = event.target.querySelector("button[type='submit']");
      submitBtn.disabled = true;

      try {
        const res = await fetch("/api/deals", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const errBody = await res.json().catch(() => ({}));
          throw new Error(errBody.error || "Failed to create deal in HubSpot");
        }

        const created = await res.json();
        setMessage(
          messageEl,
          `Deal created in HubSpot (ID: ${created.id}).`,
          "success"
        );
      } catch (err) {
        setMessage(messageEl, err.message, "error");
      } finally {
        submitBtn.disabled = false;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Existing wiring
      document
        .getElementById("refreshContactsBtn")
        .addEventListener("click", loadContacts);

      document
        .getElementById("createContactForm")
        .addEventListener("submit", handleCreateContact);

      document
        .getElementById("createDealForm")
        .addEventListener("submit", handleCreateDeal);

      // ---- AI Insights wiring ----
      const aiSummaryBtn = document.getElementById("ai-summary-btn");
      const aiStatusEl = document.getElementById("ai-status");
      const aiOutputEl = document.getElementById("ai-output");

      if (aiSummaryBtn) {
        aiSummaryBtn.addEventListener("click", async () => {
          aiStatusEl.textContent = "Generating AI insights...";
          aiOutputEl.textContent = "";

          try {
            const res = await fetch("/api/ai/summary");
            if (!res.ok) {
              throw new Error(`Request failed with status ${res.status}`);
            }

            const data = await res.json();
            aiStatusEl.textContent = "AI insights:";
            aiOutputEl.textContent = data.summary || "(No summary returned)";
          } catch (err) {
            console.error("Error fetching AI summary:", err);
            aiStatusEl.textContent =
              "Failed to generate AI insights. Please try again.";
            aiOutputEl.textContent = "";
          }
        });
      }

      // Initial load
      loadContacts();
    });

  </script>


<section style="margin-top: 2rem; padding: 1rem; border: 1px solid #ccc;">
  <h2>AI Insights</h2>
  <p>
    Click the button below to generate a short AI summary of your current
    contacts and deals in HubSpot.
  </p>
  <button id="ai-summary-btn">Generate AI summary</button>
  <p id="ai-status" style="font-style: italic; margin-top: 0.5rem;"></p>
  <pre
    id="ai-output"
    style="white-space: pre-wrap; background: #f9f9f9; padding: 0.75rem; margin-top: 0.5rem;"
  ></pre>
</section>

</body>
</html>
